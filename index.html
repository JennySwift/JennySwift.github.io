<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Jenny's BG Dashboard</title>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script>
        <style>
            body {
                font-family: sans-serif;
                margin: 2rem;
                background: #fffbe6;
            }
            h1 {
                text-align: center;
                margin-bottom: 2rem;
            }
            canvas {
                max-width: 100%;
                height: auto;
            }
            .section {
                margin-top: 3rem;
            }
        </style>
    </head>
    <body>
        <h1>Jenny's Blood Glucose Dashboard</h1>
        
        <div>
            <canvas id="bgChart"></canvas>
        </div>
        
        <div class="section">
            <h2>Food Log + Notes (coming soon)</h2>
            <p>This section will show food entries, exercise, and comments for the selected date.</p>
        </div>
        
        <script>
            fetch("https://dl.dropboxusercontent.com/scl/fi/0udoq3x6gkchstkq2hqxg/glucoseData.json?rlkey=vllvwb6wlx2el12c9aqijw37p")
            .then(response => response.json())
            .then(data => {
                const ctx = document.getElementById('bgChart').getContext('2d');
                const readings = data.readings;
                
                const dataset = readings.map(r => ({
                    x: new Date(r.timestamp),
                    y: r.value
                }));
                
                const labels = readings.map(r => {
                  const date = new Date(r.timestamp);
                  return date.toLocaleTimeString([], {
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                  });
                });
                
                const values = readings.map(r => r.value);
                
                const chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'BG (mmol/L)',
                            data: values,
                            fill: true,
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            borderColor: 'black',
                            borderWidth: 2.5,
                            tension: 0.3
                        }]
                    },
                    options: {
                        interaction: {
                          mode: 'nearest',
                          intersect: false
                        },
                        scales: {
                            y: {
                                min: 2,
                                max: 12,
                                ticks: {
                                    stepSize: 1
                                },
                                grid: {
                                    display: true,
                                    color: '#888',       // darker grey
                                    lineWidth: 1.5,
                                    drawTicks: true,
                                    drawBorder: true
                                },
                                title: {
                                    display: true,
                                    text: 'mmol/L'
                                }
                            },
                            x: {
                                ticks: {
                                    autoSkip: true,
                                    maxTicksLimit: 48,
                                    maxRotation: 0,
                                    minRotation: 0
                                },
                                title: {
                                    display: true,
                                    text: 'Time'
                                }
                            },
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                  title: (context) => {
                                      const label = context[0].label;
                                      return label;
                                    return date.toLocaleTimeString([], {
                                      hour: '2-digit',
                                      minute: '2-digit',
                                      hour12: true
                                    }); // e.g. "11:30 PM"
                                  },
                                  label: (context) => {
                                    const mmol = context.parsed.y;
                                    const mgdl = Math.round(mmol * 18);
                                    return [
                                      `ðŸ©¸ ${mmol.toFixed(1)} mmol/L`,
                                      `ðŸ©¸ ${mgdl} mg/dL`
                                    ];
                                  }
                                },
                                titleFont: {
                                  size: 18
                                },
                                bodyFont: {
                                  size: 18
                                },
                                footerFont: {
                                  size: 14
                                },
                                padding: 14,
                                usePointStyle: true,
                                labelPointStyle: {
                                  pointStyle: 'circle', // default fallback
                                  rotation: 0
                                },
                                //Removes the little white circle in the tooltip
                                displayColors: false
                              },
                            legend: {
                                display: false
                            },
                            annotation: {
                                annotations: {
                                    lowZone: {
                                        type: 'box',
                                        yMin: 0,
                                        yMax: 4,
                                        backgroundColor: 'rgba(255, 0, 0, 0.4)', // red
                                        borderWidth: 0
                                    },
                                    inRangeZone: {
                                        type: 'box',
                                        yMin: 4,
                                        yMax: 8,
                                        backgroundColor: 'rgba(0, 255, 0, 0.4)', // green
                                        borderWidth: 0
                                    },
                                    highYellowZone: {
                                        type: 'box',
                                        yMin: 8,
                                        yMax: 10,
                                        backgroundColor: 'rgba(255, 255, 0, 0.4)', // yellow
                                        borderWidth: 0
                                    },
                                    veryHighZone: {
                                        type: 'box',
                                        yMin: 10,
                                        yMax: 20, // you can raise if you ever go higher
                                        backgroundColor: 'rgba(255, 0, 0, 0.4)', // red
                                        borderWidth: 0
                                    },
                                    dynamicLine: {
                                      type: 'line',
                                      scaleID: 'x',
                                      value: null, // we'll update this dynamically
                                      borderColor: 'blue',
                                      borderWidth: 2,
                                      label: {
                                        display: false
                                      }
                                    }
                                }
                            }
                        }
                    }
                });
                
                document.getElementById('bgChart').addEventListener('mousemove', function(evt) {
                  const points = chart.getElementsAtEventForMode(evt, 'nearest', { intersect: false }, false);
                  if (points.length > 0) {
                    const index = points[0].index;
                    const label = chart.data.labels[index];
                    
                    // Update the vertical line annotation
                    chart.options.plugins.annotation.annotations.dynamicLine.value = label;
                    chart.update('none');
                  }
                });
            });
        </script>
    </body>
</html>
