<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Jenny's BG Dashboard</title>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script>
        <style>
            body {
                font-family: sans-serif;
                margin: 2rem;
                background: #fffbe6;
            }
            h1 {
                text-align: center;
                margin-bottom: 2rem;
            }
            canvas {
                max-width: 100%;
                height: auto;
            }
            .section {
                margin-top: 3rem;
            }
        </style>
    </head>
    <body>
        <h1>Jenny's Blood Glucose Dashboard</h1>
        
        <div style="margin-bottom: 1rem;">
            <button id="prevDate">‚¨ÖÔ∏è</button>
            <input type="date" id="selectedDate" />
            <button id="nextDate">‚û°Ô∏è</button>
        </div>
        
        <div style="margin-top: 1rem;">
          <label for="jumpInput">Jump to time:</label>
          <input type="text" id="jumpInput" placeholder="e.g. 2:30 PM" style="font-size: 1rem; padding: 4px;" />
        </div>
        
        <div>
            <canvas id="bgChart"></canvas>
        </div>
        
        <div class="section">
            <h2>Food Log + Notes (coming soon)</h2>
            <p>This section will show food entries, exercise, and comments for the selected date.</p>
        </div>
        
        <script>
            fetch("https://dl.dropboxusercontent.com/scl/fi/0udoq3x6gkchstkq2hqxg/glucoseData.json?rlkey=vllvwb6wlx2el12c9aqijw37p")
            .then(response => response.json())
            .then(data => {
                const ctx = document.getElementById('bgChart').getContext('2d');
                const readings = data.readings;
                
                console.log("üìÖ Raw timestamps in data:");
                readings.slice(0, 5).forEach(r => console.log("‚Üí", r.timestamp));
                
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                
                
                console.log("‚úÖ Local today (midnight AEST):", today.toString());
                const tomorrow = new Date(today);
                tomorrow.setDate(today.getDate() + 1);
                
                const dataset = readings.map(r => ({
                    x: new Date(r.timestamp),
                    y: r.value
                }));
                
                const labels = readings.map(r => {
                  const date = new Date(r.timestamp);
                  return date.toLocaleTimeString([], {
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                  });
                });
                
                const values = readings.map(r => r.value);
                
                const chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'BG (mmol/L)',
                            data: values,
                            fill: true,
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            borderColor: 'black',
                            borderWidth: 2.5,
                            tension: 0.3
                        }]
                    },
                    options: {
                        interaction: {
                          mode: 'nearest',
                          intersect: false
                        },
                        scales: {
                            y: {
                                min: 2,
                                max: 12,
                                ticks: {
                                    stepSize: 1
                                },
                                grid: {
                                    display: true,
                                    color: '#888',       // darker grey
                                    lineWidth: 1.5,
                                    drawTicks: true,
                                    drawBorder: true
                                },
                                title: {
                                    display: true,
                                    text: 'mmol/L'
                                }
                            },
                            x: {
                                ticks: {
                                    autoSkip: true,
                                    maxTicksLimit: 48,
                                    maxRotation: 0,
                                    minRotation: 0
                                },
                                title: {
                                    display: true,
                                    text: 'Time'
                                }
                            },
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                  title: (context) => {
                                      const label = context[0].label;
                                      return label;
                                    return date.toLocaleTimeString([], {
                                      hour: '2-digit',
                                      minute: '2-digit',
                                      hour12: true
                                    }); // e.g. "11:30 PM"
                                  },
                                  label: (context) => {
                                    const mmol = context.parsed.y;
                                    const mgdl = Math.round(mmol * 18);
                                    return [
                                      `ü©∏ ${mmol.toFixed(1)} mmol/L`,
                                      `ü©∏ ${mgdl} mg/dL`
                                    ];
                                  }
                                },
                                titleFont: {
                                  size: 18
                                },
                                bodyFont: {
                                  size: 18
                                },
                                footerFont: {
                                  size: 14
                                },
                                padding: 14,
                                usePointStyle: true,
                                labelPointStyle: {
                                  pointStyle: 'circle', // default fallback
                                  rotation: 0
                                },
                                //Removes the little white circle in the tooltip
                                displayColors: false
                              },
                            legend: {
                                display: false
                            },
                            annotation: {
                                annotations: {
                                    lowZone: {
                                        type: 'box',
                                        yMin: 0,
                                        yMax: 4,
                                        backgroundColor: 'rgba(255, 0, 0, 0.4)', // red
                                        borderWidth: 0
                                    },
                                    inRangeZone: {
                                        type: 'box',
                                        yMin: 4,
                                        yMax: 8,
                                        backgroundColor: 'rgba(0, 255, 0, 0.4)', // green
                                        borderWidth: 0
                                    },
                                    highYellowZone: {
                                        type: 'box',
                                        yMin: 8,
                                        yMax: 10,
                                        backgroundColor: 'rgba(255, 255, 0, 0.4)', // yellow
                                        borderWidth: 0
                                    },
                                    veryHighZone: {
                                        type: 'box',
                                        yMin: 10,
                                        yMax: 20, // you can raise if you ever go higher
                                        backgroundColor: 'rgba(255, 0, 0, 0.4)', // red
                                        borderWidth: 0
                                    },
                                    dynamicLine: {
                                      type: 'line',
                                      scaleID: 'x',
                                      value: null, // we'll update this dynamically
                                      borderColor: 'blue',
                                      borderWidth: 2,
                                      label: {
                                        display: false
                                      }
                                    }
                                }
                            }
                        }
                    }
                });
                
                updateChartForDate(today);
                
                function parseFlexibleTime(input) {
                  const clean = input.toLowerCase().replace(/\s+/g, '');
                  const match = clean.match(/^(\d{1,2})(?::(\d{2}))?(am|pm)?$/);

                  if (!match) return null;

                  let hour = parseInt(match[1]);
                  let minute = parseInt(match[2] || '0');
                  const period = match[3];

                  if (period === 'pm' && hour < 12) hour += 12;
                  if (period === 'am' && hour === 12) hour = 0;
                  if (hour >= 0 && hour < 24 && minute >= 0 && minute < 60) {
                    const date = new Date();
                    date.setHours(hour, minute, 0, 0);
                    return date;
                  }

                  return null;
                }
                
                function updateChartForDate(date) {
                  const start = new Date(date);
                  start.setHours(0, 0, 0, 0);
                  const end = new Date(start);
                  end.setDate(start.getDate() + 1);

                  const filtered = readings
                    .map(r => ({
                      timestamp: new Date(r.timestamp),
                      value: r.value
                    }))
                    .filter(r => r.timestamp >= start && r.timestamp < end);

                  console.log("üìÖ Filtering for:", start.toDateString());
                  console.log("üî¢ Found readings:", filtered.length);

                  const labels = filtered.map(r =>
                    r.timestamp.toLocaleTimeString([], {
                      hour: 'numeric',
                      minute: '2-digit',
                      hour12: true
                    })
                  );
                  const values = filtered.map(r => r.value);

                  chart.data.labels = labels;
                  chart.data.datasets[0].data = values;
                  chart.update();
                }
                
                function jumpToTime() {
                  const input = document.getElementById('jumpInput').value.trim();
                  if (!input) return;

                  const parsed = parseFlexibleTime(input);
                  if (!parsed) {
                    alert("Couldn't understand that time. Try e.g. 2:30 PM or 14:00");
                    return;
                  }

                  const labels = chart.data.labels;

                  // Format the parsed time exactly how your labels are formatted
                  const formattedTarget = parsed.toLocaleTimeString([], {
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                  });

                  let closestIndex = 0;
                  let closestDiff = Infinity;

                  for (let i = 0; i < labels.length; i++) {
                    const label = labels[i];
                    const labelDate = parseFlexibleTime(label);
                    if (!labelDate) continue;

                    const diff = Math.abs(labelDate.getTime() - parsed.getTime());
                    if (diff < closestDiff) {
                      closestDiff = diff;
                      closestIndex = i;
                    }
                  }

                  const matchedLabel = labels[closestIndex];

                  // Update vertical line annotation
                  chart.options.plugins.annotation.annotations.dynamicLine.value = matchedLabel;

                  // Set tooltip + highlight point
                  chart.setActiveElements([
                    { datasetIndex: 0, index: closestIndex }
                  ]);
                  chart.tooltip.setActiveElements([
                    { datasetIndex: 0, index: closestIndex }
                  ], { x: 0, y: 0 });

                  chart.update();
                }
                
                document.getElementById('jumpInput').addEventListener('keydown', function (e) {
                  if (e.key === 'Enter') {
                    jumpToTime();
                  }
                });
                
                document.getElementById('selectedDate').addEventListener('change', function () {
                  const selected = this.value; // Format: "YYYY-MM-DD"
                  const [yyyy, mm, dd] = selected.split('-');
                  const chosenDate = new Date(yyyy, mm - 1, dd);
                  updateChartForDate(chosenDate);
                });
                
                document.getElementById('prevDate').addEventListener('click', function () {
                  const input = document.getElementById('selectedDate');
                  let current = input.valueAsDate;

                  if (!current) {
                    console.warn("‚ö†Ô∏è prevDate: No date selected ‚Äî defaulting to today");
                    current = new Date();
                    current.setHours(0, 0, 0, 0);
                  }

                  current.setDate(current.getDate() - 1);
                  input.valueAsDate = current;
                  console.log("‚¨ÖÔ∏è Navigated to:", current.toDateString());
                  updateChartForDate(current);
                });

                document.getElementById('nextDate').addEventListener('click', function () {
                  const input = document.getElementById('selectedDate');
                  let current = input.valueAsDate;

                  if (!current) {
                    console.warn("‚ö†Ô∏è nextDate: No date selected ‚Äî defaulting to today");
                    current = new Date();
                    current.setHours(0, 0, 0, 0);
                  }

                  current.setDate(current.getDate() + 1);
                  input.valueAsDate = current;
                  console.log("‚û°Ô∏è Navigated to:", current.toDateString());
                  updateChartForDate(current);
                });
                
                document.getElementById('bgChart').addEventListener('mousemove', function(evt) {
                  const points = chart.getElementsAtEventForMode(evt, 'nearest', { intersect: false }, false);
                  if (points.length > 0) {
                    const index = points[0].index;
                    const label = chart.data.labels[index];
                    
                    // Update the vertical line annotation
                    chart.options.plugins.annotation.annotations.dynamicLine.value = label;
                    chart.update('none');
                  }
                });
            });
        </script>
    </body>
</html>
